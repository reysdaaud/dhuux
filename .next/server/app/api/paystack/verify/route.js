(()=>{var e={};e.id=420;e.ids=[420];e.modules={3295:e=>{"use strict";e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},7879:e=>{"use strict";e.exports=import("firebase-admin/firestore");},10846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},21128:(e,s,t)=>{"use strict";t.a(e,async(e,a)=>{try{t.r(s);t.d(s,{POST:()=>p});var r=t(32190);var i=t(46675);var n=t.n(i);var o=t(7879);var c=e([o]);o=(c.then?(await c)():c)[0];try{if(!n().apps.length){const e=JSON.parse(process.env.FIREBASE_ADMIN_SDK_CONFIG);n().initializeApp({credential:n().credential.cert(e)});console.log("[API /api/paystack/verify] Firebase Admin SDK initialized.")}}catch(e){console.error("[API /api/paystack/verify] Firebase Admin SDK initialization failed:",e.message)}const u=n().apps.length?(0,o.getFirestore)():null;async function p(e){console.log("[API /api/paystack/verify] Received verification request.");if(!u){console.error("[API /api/paystack/verify] Firestore Admin SDK not initialized. Cannot process request.");return r.NextResponse.json({success:false,message:"Server configuration error."},{status:500})}try{const{reference:s}=await e.json();if(!s){console.warn("[API /api/paystack/verify] Missing payment reference in request body.");return r.NextResponse.json({success:false,message:"Payment reference is required."},{status:400})}const t=process.env.PAYSTACK_SECRET_KEY;if(!t||!(t.startsWith("sk_live_")||t.startsWith("sk_test_"))){console.error("[API /api/paystack/verify] Paystack Secret Key is not configured or invalid in server environment variables (PAYSTACK_SECRET_KEY).");return r.NextResponse.json({success:false,message:"Payment gateway server configuration error. [PSK_SCFG01_SVR]"},{status:500})}console.log(`[API /api/paystack/verify] Verifying reference: ${s} with Paystack.`);const a=await fetch(`https://api.paystack.co/transaction/verify/${s}`,{method:"GET",headers:{Authorization:`Bearer ${t}`,"Content-Type":"application/json"}});const i=await a.json();console.log("[API /api/paystack/verify] Paystack verification API response status:",a.status);console.log("[API /api/paystack/verify] Paystack verification API response data:",JSON.stringify(i,null,2));if(!a.ok||!i.status||i.data?.status!=="success"){console.warn(`[API /api/paystack/verify] Paystack verification failed or payment not successful for reference ${s}. Message: ${i.message}`);return r.NextResponse.json({success:false,message:i.message||"Payment verification failed or payment not successful."},{status:400})}const n=i.data;const c=n.amount/100;const p=n.metadata;const d=p?.userId;const y=p?.coins;const l=p?.packageName;if(!d||typeof y==="undefined"){console.error(`[API /api/paystack/verify] CRITICAL: Invalid metadata from Paystack (userId or coins missing) for reference ${s}. Metadata:`,p);return r.NextResponse.json({success:true,message:"Payment verified by Paystack, but metadata issue prevented crediting coins. Contact support.",credited:false})}const f=parseInt(y,10);if(isNaN(f)||f<=0){console.error(`[API /api/paystack/verify] CRITICAL: Invalid coins value in metadata for reference ${s}. coinsToAddStr:`,y);return r.NextResponse.json({success:true,message:"Payment verified by Paystack, but coin metadata invalid. Contact support.",credited:false})}console.log(`[API /api/paystack/verify] Payment for user ${d} successful. Coins to add: ${f}, Package: ${l}`);const m=u.collection("users").doc(d);const v=await m.get();const g={amount:c,coins:f,timestamp:o.Timestamp.now(),reference:s,status:"success",gateway:"paystack",packageName:l||"N/A",gatewayResponseSummary:{ip_address:n.ip_address,currency:n.currency,channel:n.channel,card_type:n.authorization?.card_type,bank:n.authorization?.bank,country_code:n.authorization?.country_code}};if(!v.exists){console.warn(`[API /api/paystack/verify] User document for ${d} does not exist. Creating with payment info...`);await m.set({uid:d,email:n.customer?.email||"N/A",name:p?.userName||"New User",photoURL:p?.userPhotoURL||null,coins:f,paymentHistory:o.FieldValue.arrayUnion(g),createdAt:o.FieldValue.serverTimestamp(),updatedAt:o.FieldValue.serverTimestamp(),lastLogin:o.FieldValue.serverTimestamp(),profileComplete:false,isAdmin:false,freeContentConsumedCount:0,consumedContentIds:[],likedContentIds:[],savedContentIds:[],preferredCategories:[]})}else{const e=v.data()?.coins||0;const s=e+f;await m.update({coins:s,paymentHistory:o.FieldValue.arrayUnion(g),updatedAt:o.FieldValue.serverTimestamp()});console.log(`[API /api/paystack/verify] Firestore updated for user ${d}. New balance: ${s}`)}return r.NextResponse.json({success:true,message:"Payment verified and coins credited.",credited:true,coinsAdded:f})}catch(e){console.error("[API /api/paystack/verify] Error processing Paystack verification:",e.message,e.stack);return r.NextResponse.json({success:false,message:"Internal server error during payment verification."},{status:500})}}a()}catch(e){a(e)}})},29294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},44870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},46675:e=>{"use strict";e.exports=require("firebase-admin")},63033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},78335:()=>{},96487:()=>{},96833:(e,s,t)=>{"use strict";t.a(e,async(e,a)=>{try{t.r(s);t.d(s,{patchFetch:()=>d,routeModule:()=>l,serverHooks:()=>v,workAsyncStorage:()=>f,workUnitAsyncStorage:()=>m});var r=t(96559);var i=t.n(r);var n=t(48088);var o=t(37719);var c=t.n(o);var p=t(21128);var u=e([p]);p=(u.then?(await u)():u)[0];const y="";const l=new r.AppRouteRouteModule({definition:{kind:n.RouteKind.APP_ROUTE,page:"/api/paystack/verify/route",pathname:"/api/paystack/verify",filename:"route",bundlePath:"app/api/paystack/verify/route"},resolvedPagePath:"C:\\Users\\HP EliteBook\\Desktop\\minti\\minti-main\\src\\app\\api\\paystack\\verify\\route.ts",nextConfigOutput:y,userland:p});const{workAsyncStorage:f,workUnitAsyncStorage:m,serverHooks:v}=l;function d(){return(0,o.patchFetch)({workAsyncStorage:f,workUnitAsyncStorage:m})}a()}catch(e){a(e)}})}};var s=require("../../../../webpack-runtime.js");s.C(e);var t=e=>s(s.s=e);var a=s.X(0,[447,580],()=>t(96833));module.exports=a})();